# üîç An√°lise Completa de Erros de Processamento

## üìã Sum√°rio Executivo

Este documento identifica todos os poss√≠veis erros de processamento na aplica√ß√£o VKO-Web, categorizados por tipo, severidade e impacto. Cada erro inclui poss√≠veis causas, sintomas e solu√ß√µes preventivas.

---

## üö® **CATEGORIA 1: ERROS DE INICIALIZA√á√ÉO E CONFIGURA√á√ÉO**

### 1.1. **Vari√°veis de Ambiente Ausentes**
**Severidade:** üî¥ CR√çTICA  
**Arquivo:** `src/lib/supabase.ts` (linhas 3-8)

**Erro:**
```typescript
const url  = import.meta.env.VITE_SUPABASE_URL
const anon = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!url || !anon) {
  throw new Error('VITE_SUPABASE_URL/ANON_KEY n√£o definidas')
}
```

**Poss√≠veis Causas:**
- Arquivo `.env` n√£o existe ou n√£o est√° na raiz
- Vari√°veis com nomes incorretos
- Build sem vari√°veis (produ√ß√£o sem config)

**Sintomas:**
- Aplica√ß√£o n√£o inicia
- Erro no console: "VITE_SUPABASE_URL/ANON_KEY n√£o definidas"
- Tela branca imediatamente

**Solu√ß√£o Preventiva:**
- ‚úÖ Verificar `.env` na raiz do projeto
- ‚úÖ Confirmar que vari√°veis come√ßam com `VITE_`
- ‚úÖ Documentar necessidade de `.env` no README

---

### 1.2. **Inicializa√ß√£o Ass√≠ncrona do Auth Store**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/router/index.ts` (linhas 44-50)

**Erro Potencial:**
```typescript
if (!auth.session) {
  console.log('router.beforeEach: Sem sess√£o, inicializando auth...')
  await auth.init()
}
```

**Poss√≠veis Causas:**
- Race condition: m√∫ltiplas navega√ß√µes simult√¢neas
- `auth.init()` chamado m√∫ltiplas vezes
- Sess√£o expirada durante navega√ß√£o

**Sintomas:**
- Navega√ß√£o lenta
- Loops de redirecionamento
- Profile n√£o carregado ap√≥s navega√ß√£o

**Solu√ß√£o Preventiva:**
- ‚úÖ Adicionar flag `initializing` no store
- ‚úÖ Cachear resultado da inicializa√ß√£o
- ‚úÖ Verificar expira√ß√£o de sess√£o

---

## üö® **CATEGORIA 2: ERROS DE AUTENTICA√á√ÉO**

### 2.1. **Profile Null com JWT Fallback Falhando**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/stores/auth.ts` (linhas 96-184)

**Erro Potencial:**
```typescript
if (error.code === 'PGRST116' && jwtRole) {
  // Fallback funciona
} else if (error.code === 'PGRST116') {
  // Criar perfil b√°sico - PODE FALHAR
  const { error: insertError } = await supabase
    .from('users_profile')
    .insert({ ... })
}
```

**Poss√≠veis Causas:**
- RLS bloqueando INSERT mesmo para admin
- Constraints violadas (email duplicado, etc.)
- Rede desconectada durante inser√ß√£o
- `insertError` n√£o tratado adequadamente

**Sintomas:**
- Login trava no "carregando"
- Profile fica null indefinidamente
- Aplica√ß√£o funcional mas sem permiss√µes

**Solu√ß√£o Preventiva:**
- ‚úÖ Sempre usar JWT fallback primeiro
- ‚úÖ Logar erro de INSERT mas n√£o bloquear
- ‚úÖ Adicionar retry logic
- ‚úÖ Timeout de 5s para opera√ß√µes cr√≠ticas

---

### 2.2. **Sess√£o Expirada N√£o Detectada**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/stores/auth.ts` (linha 33)

**Erro Potencial:**
```typescript
supabase.auth.onAuthStateChange(async (_e, s) => {
  this.session = s
  if (s?.user) await this.fetchProfile()
})
```

**Poss√≠veis Causas:**
- Evento de logout n√£o disparado
- Token expirado mas sess√£o n√£o atualizada
- M√∫ltiplas abas com estados diferentes

**Sintomas:**
- Usu√°rio v√™ dados mesmo ap√≥s logout
- Erros 401 em requisi√ß√µes subsequentes
- UI n√£o atualiza ap√≥s expira√ß√£o

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar expira√ß√£o do token antes de requisi√ß√µes
- ‚úÖ Escutar eventos de erro de auth (401/403)
- ‚úÖ Sincronizar estado entre abas (localStorage)

---

### 2.3. **SignUp Sem Tratamento de Email Confirmation**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/stores/auth.ts` (linhas 46-79)

**Erro Potencial:**
```typescript
if (data.user && !data.user.email_confirmed_at) {
  return { message: 'Conta criada! Verifique seu email...' }
}
// Se chegou aqui, tentar criar perfil - MAS E SE FALHAR?
if (data.user) {
  await supabase.from('users_profile').insert({ ... })
}
```

**Poss√≠veis Causas:**
- Email n√£o confirmado mas perfil criado mesmo assim
- Perfil duplicado ao confirmar email depois
- RLS impedindo cria√ß√£o para usu√°rio n√£o confirmado

**Sintomas:**
- Usu√°rio n√£o consegue fazer login ap√≥s registro
- Duplica√ß√£o de perfis
- Erros ao criar perfil

**Solu√ß√£o Preventiva:**
- ‚úÖ S√≥ criar perfil se email confirmado (ou flag configurada)
- ‚úÖ Usar `upsert` com `ON CONFLICT` no banco
- ‚úÖ Valida√ß√£o de email √∫nico antes de INSERT

---

## üö® **CATEGORIA 3: ERROS DE NAVEGA√á√ÉO E ROTEAMENTO**

### 3.1. **Loops de Redirecionamento**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/router/index.ts` (linhas 44-79)

**Erro Potencial:**
```typescript
if (to.matched.some(record => record.meta.requiresAuth)) {
  if (!auth.session) {
    return { path: '/login', query: { r: to.fullPath } }
  }
}

if (to.path.startsWith('/app') && !auth.session) {
  return { path: '/login', query: { r: to.fullPath } }
}
```

**Poss√≠veis Causas:**
- Verifica√ß√£o duplicada (overlap de guards)
- Session sendo resetada durante navega√ß√£o
- Query `?r=` causando redirect loop

**Sintomas:**
- Aplica√ß√£o fica redirecionando infinitamente
- Console mostra m√∫ltiplos `beforeEach` logs
- Navegador mostra "too many redirects"

**Solu√ß√£o Preventiva:**
- ‚úÖ Remover verifica√ß√£o duplicada
- ‚úÖ Cachear resultado do guard (por rota)
- ‚úÖ Adicionar max redirects (3 tentativas)

---

### 3.2. **RequireAdmin Sem Tratamento de Profile Null**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/router/index.ts` (linhas 65-70)

**Erro Potencial:**
```typescript
if (to.matched.some(record => record.meta.requireAdmin)) {
  if (!auth.profile || auth.profile.role !== 'admin') {
    return { path: '/app' }
  }
}
```

**Poss√≠veis Causas:**
- Profile ainda carregando (`null`)
- Profile com role incorreta (n√£o atualizado)
- Fallback JWT com role diferente do banco

**Sintomas:**
- Admin n√£o consegue acessar rotas admin
- Redirect prematuro antes de profile carregar
- Acesso negado mesmo sendo admin

**Solu√ß√£o Preventiva:**
- ‚úÖ Aguardar carregamento do profile (timeout)
- ‚úÖ Mostrar loading durante verifica√ß√£o
- ‚úÖ Verificar JWT role como fallback aqui tamb√©m

---

## üö® **CATEGORIA 4: ERROS DE SERVI√áOS E API**

### 4.1. **Upload de Relat√≥rio Sem Rollback**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/services/reports.ts` (linhas 23-75)

**Erro Potencial:**
```typescript
// Upload do arquivo
const { error: upErr } = await supabase.storage.from('reports').upload(path, file, { upsert: true })
if (upErr) throw new Error(...)

// Inserir metadados - SE FALHAR, ARQUIVO FICA √ìRF√ÉO
const { error: insErr } = await supabase.from('reports').insert({ ... })
if (insErr) {
  // ‚úÖ J√Å TEM ROLLBACK - MAS PODE FALHAR
  await supabase.storage.from('reports').remove([path])
  throw new Error(...)
}
```

**Poss√≠veis Causas:**
- Rollback de storage falha (arquivo n√£o removido)
- Erro de rede durante rollback
- Permiss√µes de storage impedem remo√ß√£o

**Sintomas:**
- Arquivos √≥rf√£os no storage
- Erro ao salvar, mas arquivo j√° enviado
- Storage cheio com arquivos in√∫teis

**Solu√ß√£o Preventiva:**
- ‚úÖ Transa√ß√£o at√¥mica (n√£o poss√≠vel no Supabase)
- ‚úÖ Job de limpeza peri√≥dico de arquivos √≥rf√£os
- ‚úÖ Logs detalhados para debugging
- ‚úÖ Tentar rollback m√∫ltiplas vezes

---

### 4.2. **GetSignedUrl Sem Cache de Expira√ß√£o**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/services/reports.ts` (linhas 77-99)

**Erro Potencial:**
```typescript
const { data, error } = await supabase.storage.from('reports').createSignedUrl(path, 3600)
```

**Poss√≠veis Causas:**
- URL expira ap√≥s 1h mas ainda est√° em cache
- M√∫ltiplas requisi√ß√µes gerando URLs desnecess√°rias
- URL expirada sendo usada em bot√µes de download

**Sintomas:**
- Bot√£o "Baixar" mostra erro 403 ap√≥s 1h
- Performance degradada (muitas requisi√ß√µes)
- UX ruim (download falha silenciosamente)

**Solu√ß√£o Preventiva:**
- ‚úÖ Cachear URL com timestamp de expira√ß√£o
- ‚úÖ Regenerar URL automaticamente se expirada
- ‚úÖ Validar URL antes de mostrar bot√£o

---

### 4.3. **ACL RPC Sem Valida√ß√£o de Par√¢metros**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/services/acl.ts` (linhas 27-48)

**Erro Potencial:**
```typescript
export async function setReportAccess(params: SetReportAccessParams) {
  const { p_report_id, p_subject_type, p_subject_id, ... } = params
  
  try {
    const { error } = await supabase.rpc('set_report_access', { ... })
    if (error) throw new Error(`Erro ao liberar acesso: ${error.message}`)
  }
}
```

**Poss√≠veis Causas:**
- UUIDs inv√°lidos sendo passados
- `subject_type` com valor incorreto
- RPC n√£o existe no banco (schema n√£o atualizado)

**Sintomas:**
- Erros gen√©ricos do Supabase (n√£o informativos)
- ACL n√£o funciona mas n√£o mostra causa
- Debugging dif√≠cil

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar UUIDs antes de chamar RPC
- ‚úÖ Validar enum `subject_type`
- ‚úÖ Mensagens de erro mais descritivas
- ‚úÖ Verificar exist√™ncia de RPC (health check)

---

### 4.4. **DeleteAsset Sem Cascade Check**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/services/assets.ts` (linhas 36-51)

**Erro Potencial:**
```typescript
export async function deleteAsset(assetId: string) {
  const { error } = await supabase
    .from('assets')
    .delete()
    .eq('id', assetId)
}
```

**Poss√≠veis Causas:**
- Asset tem reports vinculados (FK constraint)
- Asset est√° em `user_assets` (FK constraint)
- Asset est√° em `asset_acl` (FK constraint)

**Sintomas:**
- Erro ao deletar: "violates foreign key constraint"
- Asset n√£o deletado mas n√£o mostra motivo
- UI fica em estado de "deletando"

**Solu√ß√£o Preventiva:**
- ‚úÖ Verificar depend√™ncias antes de deletar
- ‚úÖ Mostrar aviso se houver reports/ACLs vinculados
- ‚úÖ Op√ß√£o de cascade delete (cuidado!)
- ‚úÖ Mensagem clara: "Asset possui X relat√≥rios vinculados"

---

### 4.5. **ListAssetsVisible Sem Tratamento de RLS**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/services/assets.ts` (linhas 56-73)

**Erro Potencial:**
```typescript
export async function listAssetsVisible() {
  const { data, error } = await supabase
    .from('assets')
    .select('id, name, code, company_id, status')
    .order('name', { ascending: true })
}
```

**Poss√≠veis Causas:**
- RLS retorna array vazio (n√£o √© erro, mas pode confundir)
- RLS bloqueia completamente (erro 403)
- RLS permite mas retorna dados incorretos

**Sintomas:**
- Tela mostra "Nenhum ativo encontrado" quando deveria ter
- Erro 403 n√£o tratado graciosamente
- Dados incorretos sendo exibidos

**Solu√ß√£o Preventiva:**
- ‚úÖ Diferenciar "vazio por RLS" de "erro real"
- ‚úÖ Mostrar mensagem: "Voc√™ n√£o tem acesso a nenhum ativo"
- ‚úÖ Log de erros 403 para debugging
- ‚úÖ Verificar permiss√µes antes de listar

---

## üö® **CATEGORIA 5: ERROS DE RUNTIME E UI**

### 5.1. **Null Reference no Profile**
**Severidade:** üü° M√âDIA  
**Arquivo:** M√∫ltiplos (ex: `ReportNew.vue` linha 325)

**Erro Potencial:**
```typescript
await uploadReportPPT(
  selectedFile.value,
  form.assetId,
  form.title,
  form.weekStart,
  auth.profile!.id  // ‚ùå Pode ser null
)
```

**Poss√≠veis Causas:**
- Profile ainda carregando
- Profile foi removido durante opera√ß√£o
- Fallback n√£o funcionou

**Sintomas:**
- Erro: "Cannot read property 'id' of null"
- Tela quebra ao tentar upload
- Upload falha sem mensagem clara

**Solu√ß√£o Preventiva:**
- ‚úÖ Sempre verificar `auth.profile?.id` antes de usar
- ‚úÖ Disable bot√£o se profile n√£o carregado
- ‚úÖ Mostrar loading enquanto profile carrega
- ‚úÖ Redirecionar se profile for null ap√≥s timeout

---

### 5.2. **Race Condition em M√∫ltiplos Uploads**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/ReportNew.vue` (linhas 304-349)

**Erro Potencial:**
```typescript
const handleSubmit = async () => {
  // Usu√°rio clica m√∫ltiplas vezes rapidamente
  loading.value = true  // ‚ùå Pode ser resetado
  await uploadReportPPT(...)
}
```

**Poss√≠veis Causas:**
- Bot√£o n√£o desabilitado durante upload
- Usu√°rio clica v√°rias vezes antes de `loading = true`
- Upload paralelo de mesmo arquivo

**Sintomas:**
- M√∫ltiplos uploads do mesmo arquivo
- Duplica√ß√£o de reports
- Storage polu√≠do

**Solu√ß√£o Preventiva:**
- ‚úÖ Disable bot√£o imediatamente no in√≠cio
- ‚úÖ Usar flag `isSubmitting` separada de `loading`
- ‚úÖ Validar se arquivo j√° est√° sendo enviado
- ‚úÖ Debounce no bot√£o (200ms)

---

### 5.3. **Formato de Data Inv√°lido**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/Dashboard.vue` (linhas 215-218)

**Erro Potencial:**
```typescript
const formatDate = (dateString: string) => {
  const date = new Date(dateString)
  return date.toLocaleDateString('pt-BR')
}
```

**Poss√≠veis Causas:**
- `dateString` √© `null` ou `undefined`
- Formato de data inv√°lido do banco
- Timezone causando datas incorretas

**Sintomas:**
- Erro: "Invalid Date"
- Datas mostrando "Invalid Date" na UI
- Datas com offset incorreto

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar `dateString` antes de usar
- ‚úÖ Try-catch em `formatDate`
- ‚úÖ Fallback: "Data inv√°lida"
- ‚úÖ Usar biblioteca de datas (date-fns)

---

### 5.4. **Promise.all Sem Tratamento Individual**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/pages/Dashboard.vue` (linhas 178-188)

**Erro Potencial:**
```typescript
const reportsWithUrls = await Promise.all(
  reportsData.map(async (report) => {
    try {
      const signedUrl = await getSignedUrl(report.file_path)
      return { ...report, signedUrl }
    } catch (error) {
      // ‚úÖ Tem try-catch - MAS PODE FALHAR ANTES
      return { ...report, signedUrl: null }
    }
  })
)
```

**Poss√≠veis Causas:**
- Se `reportsData` for `undefined`, `map` quebra
- Se `getSignedUrl` falhar antes do try, uncaught error
- M√∫ltiplas falhas simult√¢neas sobrecarregam

**Sintomas:**
- Tela quebra se houver um report inv√°lido
- Array vazio n√£o tratado
- Performance ruim com muitos reports

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar `reportsData` antes de `map`
- ‚úÖ Usar `Promise.allSettled` ao inv√©s de `Promise.all`
- ‚úÖ Limitar quantidade de reports processados
- ‚úÖ Paginar URLs assinadas (carregar sob demanda)

---

### 5.5. **Search Input Sem Debounce**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/AdminAssets.vue` (linhas 291-298)

**Erro Potencial:**
```typescript
const search = ref('')
const filteredAssets = computed(() => {
  const q = search.value.trim().toLowerCase()
  return assets.value.filter(a => ...)
})
```

**Poss√≠veis Causas:**
- Recomputa√ß√£o a cada tecla digitada
- Muitos assets causam lag ao digitar
- Search sem limite de caracteres

**Sintomas:**
- UI lenta ao digitar
- Lag vis√≠vel no campo de busca
- Alto uso de CPU

**Solu√ß√£o Preventiva:**
- ‚úÖ Debounce de 300ms no input
- ‚úÖ Limitar busca a X caracteres m√≠nimos
- ‚úÖ Virtual scrolling para lista grande
- ‚úÖ Cachear resultados filtrados

---

### 5.6. **Pagination Sem Valida√ß√£o de Bounds**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/AdminAssets.vue` (linhas 393-411)

**Erro Potencial:**
```typescript
<button 
  @click="page = Math.max(1, page - 1)" 
  :disabled="page === 1"
>
```

**Poss√≠veis Causas:**
- `page` pode ser setado para valor inv√°lido externamente
- `pageCount` pode ser 0 (divis√£o por zero)
- Navega√ß√£o r√°pida causando estados inconsistentes

**Sintomas:**
- P√°gina mostra lista vazia
- Bot√µes desabilitados incorretamente
- Erro ao calcular `pageCount`

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar `page` no computed
- ‚úÖ Watcher para corrigir `page` se inv√°lido
- ‚úÖ `pageCount` nunca pode ser < 1

---

## üö® **CATEGORIA 6: ERROS DE TIPAGEM E TYPE SAFETY**

### 6.1. **Type Assertion Perigosa**
**Severidade:** üü¢ BAIXA  
**Arquivo:** M√∫ltiplos (ex: `auth.ts` linha 177)

**Erro Potencial:**
```typescript
this.profile = data as Profile
```

**Poss√≠veis Causas:**
- `data` pode n√£o ter todos os campos de `Profile`
- `role` pode ser valor n√£o esperado
- Type narrowing n√£o aplicado

**Sintomas:**
- Erros em runtime se estrutura mudar
- TypeScript n√£o detecta incompatibilidade
- C√≥digo quebra silenciosamente

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar schema com biblioteca (zod/yup)
- ‚úÖ Type guards ao inv√©s de assertions
- ‚úÖ Runtime validation de objetos

---

### 6.2. **Any Type Usage**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/stores/auth.ts` (linha 15)

**Erro Potencial:**
```typescript
session: null as any,
```

**Poss√≠veis Causas:**
- Type do Supabase n√£o importado
- Tipagem n√£o dispon√≠vel
- Workaround r√°pido sem resolver

**Sintomas:**
- Perda de autocomplete
- Erros n√£o detectados pelo TS
- Refactoring mais dif√≠cil

**Solu√ß√£o Preventiva:**
- ‚úÖ Importar tipos do `@supabase/supabase-js`
- ‚úÖ Definir interface pr√≥pria para Session
- ‚úÖ Usar `Session | null` ao inv√©s de `any`

---

## üö® **CATEGORIA 7: ERROS DE L√ìGICA DE NEG√ìCIO**

### 7.1. **ACL Toggle Sem Feedback Visual Imediato**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/AdminAssets.vue` (linhas 126-143)

**Erro Potencial:**
```typescript
async function toggleRole(...) {
  try {
    const { error } = await supabase.rpc('set_asset_access', { ... })
    if (error) {
      alert(`Erro ao atualizar ACL: ${error.message}`)
    } else {
      await refreshAcl(assetId)  // ‚ùå Pode demorar
    }
  }
}
```

**Poss√≠veis Causas:**
- Clique n√£o mostra feedback imediato
- Usu√°rio clica m√∫ltiplas vezes pensando que n√£o funcionou
- `refreshAcl` pode demorar ou falhar

**Sintomas:**
- UX ruim (clicou mas n√£o viu mudan√ßa)
- M√∫ltiplos toggles acionados
- Estado inconsistente na UI

**Solu√ß√£o Preventiva:**
- ‚úÖ Otimistic update (mudar UI antes de confirmar)
- ‚úÖ Loading state no bot√£o durante toggle
- ‚úÖ Desabilitar bot√£o durante opera√ß√£o
- ‚úÖ Rollback se RPC falhar

---

### 7.2. **CreateAsset Sem Valida√ß√£o de Duplicatas**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/pages/AdminAssets.vue` (linhas 145-197)

**Erro Potencial:**
```typescript
async function createAsset() {
  if (!name.value.trim()) {
    alert('Informe o nome do ativo')
    return
  }
  // ‚ùå N√£o valida se nome j√° existe
  const { data, error } = await supabase.from('assets').insert({ ... })
}
```

**Poss√≠veis Causas:**
- Asset com mesmo nome criado duas vezes
- Constraint de unique no banco n√£o existe
- Duplica√ß√£o indesejada

**Sintomas:**
- Assets duplicados na lista
- Erro de constraint no banco (se existir)
- Dados inconsistentes

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar se nome j√° existe antes de inserir
- ‚úÖ Constraint UNIQUE no banco (name + company_id?)
- ‚úÖ Mensagem: "Ativo com este nome j√° existe"
- ‚úÖ Op√ß√£o de editar ao inv√©s de criar novo

---

### 7.3. **File Upload Sem Valida√ß√£o de Extens√£o Real**
**Severidade:** üü° M√âDIA  
**Arquivo:** `src/pages/ReportNew.vue` (linhas 245-291)

**Erro Potencial:**
```typescript
// Valida MIME type, mas n√£o valida extens√£o real do arquivo
const allowedTypes = [
  'application/vnd.ms-powerpoint',
  'application/vnd.openxmlformats-officedocument.presentationml.presentation'
]
if (!allowedTypes.includes(file.type)) {
  throw new Error('Apenas arquivos PPT/PPTX s√£o permitidos')
}
```

**Poss√≠veis Causas:**
- Arquivo renomeado com extens√£o `.ppt` mas √© `.exe`
- MIME type pode ser falsificado
- Bypass da valida√ß√£o

**Sintomas:**
- Arquivo malicioso enviado
- Storage polu√≠do
- Seguran√ßa comprometida

**Solu√ß√£o Preventiva:**
- ‚úÖ Validar extens√£o do nome do arquivo tamb√©m
- ‚úÖ Validar magic bytes (assinatura do arquivo)
- ‚úÖ Valida√ß√£o no backend (Supabase Edge Function)
- ‚úÖ Scannear arquivo antes de salvar

---

## üö® **CATEGORIA 8: ERROS DE PERFORMANCE**

### 8.1. **Carregamento de ACL Para Todos os Assets**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/AdminAssets.vue` (linhas 80-84)

**Erro Potencial:**
```typescript
// Carregar ACL dos primeiros itens
const itemsToLoad = assets.value.slice(0, pageSize.value)
for (const a of itemsToLoad) {
  await refreshAcl(a.id)  // ‚ùå Sequencial, lento
}
```

**Poss√≠veis Causas:**
- Loop sequencial (uma requisi√ß√£o por vez)
- ACL carregado mesmo para itens n√£o vis√≠veis
- Muitas requisi√ß√µes ao carregar p√°gina

**Sintomas:**
- P√°gina demora para carregar
- M√∫ltiplas requisi√ß√µes desnecess√°rias
- Performance ruim com muitos assets

**Solu√ß√£o Preventiva:**
- ‚úÖ Usar `Promise.all` para paralelizar
- ‚úÖ Carregar ACL apenas ao expandir/focar item
- ‚úÖ Cachear ACL carregado
- ‚úÖ Paginar ACL tamb√©m

---

### 8.2. **URLs Assinadas Sem Lazy Loading**
**Severidade:** üü¢ BAIXA  
**Arquivo:** `src/pages/Dashboard.vue` (linhas 178-188)

**Erro Potencial:**
```typescript
// Gera URL assinada para TODOS os reports de uma vez
const reportsWithUrls = await Promise.all(
  reportsData.map(async (report) => {
    const signedUrl = await getSignedUrl(report.file_path)
    return { ...report, signedUrl }
  })
)
```

**Poss√≠veis Causas:**
- URLs geradas mesmo para reports n√£o visualizados
- URLs expiram antes de serem usadas
- Muitas requisi√ß√µes simult√¢neas

**Sintomas:**
- Loading lento na lista de reports
- URLs expiradas quando usu√°rio clica
- Alto uso de API quota

**Solu√ß√£o Preventiva:**
- ‚úÖ Gerar URL apenas ao clicar no bot√£o "Baixar"
- ‚úÖ Cachear URL recentemente gerada
- ‚úÖ Mostrar loading no bot√£o individual
- ‚úÖ Lazy load: gerar ao hover no item

---

## üìä **RESUMO DE PRIORIDADES**

### üî¥ **CR√çTICO (Resolver Imediatamente)**
1. Vari√°veis de ambiente ausentes (1.1)

### üü° **M√âDIO (Resolver em Pr√≥xima Sprint)**
2. Profile null com fallback falhando (2.1)
3. Loops de redirecionamento (3.1)
4. RequireAdmin sem tratamento de profile null (3.2)
5. Upload sem rollback adequado (4.1)
6. ACL RPC sem valida√ß√£o (4.3)
7. DeleteAsset sem cascade check (4.4)
8. Null reference no profile (5.1)
9. Promise.all sem tratamento individual (5.4)
10. CreateAsset sem valida√ß√£o de duplicatas (7.2)
11. File upload sem valida√ß√£o completa (7.3)

### üü¢ **BAIXO (Melhorias Futuras)**
- Todos os demais itens listados

---

## ‚úÖ **A√á√ïES RECOMENDADAS**

### **Imediatas:**
1. Adicionar valida√ß√£o de env no startup
2. Adicionar try-catch em todos os null references
3. Adicionar valida√ß√£o de par√¢metros em ACL
4. Adicionar verifica√ß√£o de depend√™ncias antes de deletar

### **Curto Prazo:**
1. Implementar optimistic updates
2. Adicionar debounce em buscas
3. Melhorar tratamento de erros com mensagens descritivas
4. Adicionar logging estruturado

### **Longo Prazo:**
1. Implementar testes unit√°rios
2. Adicionar E2E tests para fluxos cr√≠ticos
3. Implementar monitoramento de erros (Sentry)
4. Documentar todos os edge cases

---

**Documento gerado em:** 2024-01-XX  
**Vers√£o:** 1.0  
**√öltima atualiza√ß√£o:** An√°lise inicial completa


